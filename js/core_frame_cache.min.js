(function(window){if(!window.BX.frameCache){var BX=window.BX,localStorageKey="compositeCache",localStorageKeyPullConfig="pullConfigCache",lolalStorageTTL=1440,compositeMessageIds=["bitrix_sessid","USER_ID","SERVER_TIME","USER_TZ_OFFSET","USER_TZ_AUTO"],compositeDataFile="/bitrix/tools/composite_data.php",sessidWasUpdated=!1;BX.frameCache=function(){},BX.browser.IsIE8()?BX.frameCache.localStorage=new BX.localStorageIE8:"undefined"!=typeof localStorage?BX.frameCache.localStorage=new BX.localStorage:BX.frameCache.localStorage={set:BX.DoNothing,get:function(){return null},remove:BX.DoNothing},BX.frameCache.localStorage.prefix=function(){return"bx-"},BX.frameCache.init=function(){this.cacheDataBase=null,this.tableParams={tableName:"composite",fields:[{name:"id",unique:!0},"content","hash","props"]},this.frameData=null,BX.type.isString(window.frameDataString)&&window.frameDataString.length>0&&BX.frameCache.onFrameDataReceived(window.frameDataString),this.vars=window.frameCacheVars?window.frameCacheVars:{page_url:"",params:{},storageBlocks:[]},this.lastReplacedBlocks=!1;for(var e=BX.frameCache.localStorage.get(localStorageKey)||{},a=0;a<compositeMessageIds.length;a++){var t=compositeMessageIds[a];void 0!==BX.message[t]&&(e[t]=BX.message[t])}BX.frameCache.localStorage.set(localStorageKey,e,lolalStorageTTL),BX.addCustomEvent("onBXMessageNotFound",(function(e){if(BX.util.in_array(e,compositeMessageIds)){var a=BX.frameCache.localStorage.get(localStorageKey);a&&void 0!==a[e]?BX.message[e]=a[e]:BX.frameCache.getCompositeMessages()}})),window.frameUpdateInvoked||(this.update(!1),window.frameUpdateInvoked=!0),window.frameRequestStart&&BX.ready((function(){BX.onCustomEvent("onCacheDataRequestStart"),BX.frameCache.tryUpdateSessid()})),window.frameRequestFail&&BX.ready((function(){setTimeout((function(){BX.onCustomEvent("onFrameDataRequestFail",[window.frameRequestFail])}),0)})),BX.frameCache.insertBanner()},BX.frameCache.getCompositeMessages=function(){try{BX.ajax({method:"GET",dataType:"json",url:compositeDataFile,async:!1,data:"",onsuccess:function(e){BX.frameCache.setCompositeVars(e)}})}catch(e){BX.debug("Composite sync request failed.")}},BX.frameCache.setCompositeVars=function(e){if(e){e.lang&&(e=e.lang);var a=BX.frameCache.localStorage.get(localStorageKey)||{};for(var t in e)e.hasOwnProperty(t)&&(BX.message[t]=e[t],BX.util.in_array(t,compositeMessageIds)&&(a[t]=e[t]));BX.frameCache.localStorage.set(localStorageKey,a,lolalStorageTTL)}},BX.frameCache.setPullConfigVars=function(e){if(e&&e.pull){var a=BX.frameCache.localStorage.get(localStorageKeyPullConfig),t=!1;if(null!=a){var s=e.pull.CHANNEL_ID.split("/"),r=a.CHANNEL_ID.split("/");t=s[0]!=r[0]||s[1]!=r[1]}else t=!0;var i=e.pull.CHANNEL_DT.split("/"),o=Math.min(parseInt(i[0]),parseInt(i[1]))+43200-Math.round((new Date).getTime()/1e3);BX.frameCache.localStorage.set(localStorageKeyPullConfig,e.pull,o),t&&BX.onCustomEvent("pullConfigHasBeenChanged",[e.pull])}},BX.frameCache.getPullConfig=function(){return this.frameData&&this.frameData.pull?this.frameData.pull:BX.frameCache.localStorage.get(localStorageKeyPullConfig)},BX.frameCache.processData=function(e){if(e){var a=null,t=null,s=null,r="bxdynamic_";if(e.ID.substr(0,r.length)===r){if(t=BX(e.ID+"_start"),s=BX(e.ID+"_end"),!t||!s)return void BX.debug("Dynamic area "+e.ID+" was not found")}else if(!(a=BX(e.ID)))return void BX.debug("Container "+e.ID+" was not found");var i=!1,o=!1,n=function(){var a={styles:[],inlineJS:[],externalJS:[]};if(!BX.type.isArray(e.PROPS.STRINGS)||e.PROPS.STRINGS.length<1)return a;for(var t=BX.processHTML(e.PROPS.STRINGS.join(""),!1),s=0,r=t.SCRIPT.length;s<r;s++){var i=t.SCRIPT[s];i.isInternal?a.inlineJS.push(i.JS):a.externalJS.push(i.JS)}return a.styles=t.STYLE,a}();!function(a){var t=n.styles;BX.type.isArray(e.PROPS.CSS)&&e.PROPS.CSS.length>0&&(t=BX.util.array_merge(e.PROPS.CSS,t));t.length>0?BX.load(t,a):a()}((function(){a?e.PROPS.USE_ANIMATION?(a.style.opacity=0,a.innerHTML=e.CONTENT,new BX.easing({duration:1500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){a.style.opacity=e.opacity/100},complete:function(){a.style.cssText=""}}).animate()):a.innerHTML=e.CONTENT:(BX.frameCache.removeNodes(t,s),t.insertAdjacentHTML("afterEnd",e.CONTENT));i=!0,o&&l()})),BX.evalGlobal(n.inlineJS.join(";")),function(a){var t=n.externalJS;BX.type.isArray(e.PROPS.JS)&&e.PROPS.JS.length>0&&(t=BX.util.array_merge(t,e.PROPS.JS));t.length>0?BX.load(t,a):a()}(l)}function l(){o=!0,i&&BX.ajax.processRequestData(e.CONTENT,{scriptsRunFirst:!1,dataType:"HTML"}),BX.type.isArray(e.PROPS.BUNDLE_JS)&&BX.setJSList(e.PROPS.BUNDLE_JS),BX.type.isArray(e.PROPS.BUNDLE_CSS)&&BX.setCSSList(e.PROPS.BUNDLE_CSS)}},BX.frameCache.removeNodes=function(e,a){for(var t=!1,s=e.parentNode,r=Array.prototype.slice.call(s.childNodes),i=0,o=r.length;i<o;i++)if(t){if(r[i]===a)break;s.removeChild(r[i])}else r[i]===e&&(t=!0)},BX.frameCache.update=function(e,a){a=!!a,(e=void 0===e||e)&&this.requestData(),a||BX.ready(BX.proxy((function(){this.frameData||this.invokeCache()}),this))},BX.frameCache.invokeCache=function(){this.vars.storageBlocks&&this.vars.storageBlocks.length>0&&(BX.onCustomEvent(this,"onCacheInvokeBefore",[this.vars.storageBlocks]),this.readCacheWithID(this.vars.storageBlocks,BX.proxy(this.insertFromCache,this)))},BX.frameCache.handleResponse=function(e){if(null!=e&&(BX.onCustomEvent("onFrameDataReceivedBefore",[e]),e.dynamicBlocks&&e.dynamicBlocks.length>0&&(this.insertBlocks(e.dynamicBlocks,!1),this.writeCache(e.dynamicBlocks)),BX.onCustomEvent("onFrameDataReceived",[e]),"1"==e.isManifestUpdated&&"APPCACHE"===this.vars.CACHE_MODE&&window.applicationCache.update(),!0===e.htmlCacheChanged&&"HTMLCACHE"===this.vars.CACHE_MODE&&BX.onCustomEvent("onHtmlCacheChanged",[e]),BX.type.isArray(e.spread)))for(var a=0;a<e.spread.length;a++)(new Image).src=e.spread[a]},BX.frameCache.requestData=function(){var e=[{name:"BX-ACTION-TYPE",value:"get_dynamic"},{name:"BX-REF",value:document.referrer},{name:"BX-CACHE-MODE",value:this.vars.CACHE_MODE}];"APPCACHE"===this.vars.CACHE_MODE&&(e.push({name:"BX-APPCACHE-PARAMS",value:JSON.stringify(this.vars.PARAMS)}),e.push({name:"BX-APPCACHE-URL",value:this.vars.PAGE_URL?this.vars.PAGE_URL:""})),BX.onCustomEvent("onCacheDataRequestStart");var a=window.location.href,t=a.indexOf("#");t>0&&(a=a.substring(0,t)),a+=(a.indexOf("?")>=0?"&":"?")+"bxrand="+(new Date).getTime(),BX.ajax({timeout:60,method:"GET",url:a,data:{},headers:e,skipBxHeader:!0,processData:!1,onsuccess:BX.proxy(BX.frameCache.onFrameDataReceived,this),onfailure:function(){var e={error:!0,reason:"bad_response",url:a,xhr:this.xhr,status:this.xhr?this.xhr.status:0};BX.onCustomEvent("onFrameDataRequestFail",[e])}})},BX.frameCache.onFrameDataReceived=function(response){var result=null;try{eval("result = "+response),this.frameData=result}catch(e){return void BX.ready((function(){setTimeout((function(){BX.onCustomEvent("onFrameDataRequestFail",[{error:!0,reason:"bad_eval",response:response}])}),0)}))}this.frameData&&BX.type.isNotEmptyString(this.frameData.redirect_url)?window.location=this.frameData.redirect_url:this.frameData&&!0===this.frameData.error?BX.ready(BX.proxy((function(){setTimeout(BX.proxy((function(){BX.onCustomEvent("onFrameDataRequestFail",[this.frameData])}),this),0)}),this)):(BX.frameCache.setCompositeVars(this.frameData),BX.frameCache.setPullConfigVars(this.frameData),BX.ready(BX.proxy((function(){this.handleResponse(this.frameData),this.tryUpdateSessid()}),this)))},BX.frameCache.insertFromCache=function(e,a){if(!this.frameData){var t=e.items;if(t.length>0){for(var s=0;s<t.length;s++)t[s].PROPS=JSON.parse(t[s].PROPS);this.insertBlocks(t,!0)}BX.onCustomEvent(this,"onCacheInvokeAfter",[this.vars.storageBlocks,e])}},BX.frameCache.insertBlocks=function(e,a){for(var t=0!=this.lastReplacedBlocks.length,s=0;s<e.length;s++){var r=e[s];if(BX.onCustomEvent("onBeforeDynamicBlockUpdate",[r,a]),!1!==r.PROPS.AUTO_UPDATE){var i=!1;if(t)for(var o=0;o<this.lastReplacedBlocks.length;o++)if(this.lastReplacedBlocks[o].ID==r.ID&&this.lastReplacedBlocks[o].HASH==r.HASH){i=!0;break}i||this.processData(r)}}BX.onCustomEvent("onFrameDataProcessed",[e,a]),this.lastReplacedBlocks=e},BX.frameCache.writeCache=function(e){for(var a=0;a<e.length;a++)!0===e[a].PROPS.USE_BROWSER_STORAGE&&this.writeCacheWithID(e[a].ID,e[a].CONTENT,e[a].HASH,JSON.stringify(e[a].PROPS))},BX.frameCache.openDatabase=function(){var e=null!=this.cacheDataBase;return e||(this.cacheDataBase=BX.dataBase.create({name:"Database",displayName:"BXCacheBase",capacity:4194304,version:"1.0"}),null!=this.cacheDataBase&&(this.cacheDataBase.createTable(this.tableParams),e=!0)),e},BX.frameCache.writeCacheWithID=function(e,a,t,s){BX.frameCache.openDatabase()&&("object"==typeof s&&(s=JSON.stringify(s)),this.cacheDataBase.getRows({tableName:this.tableParams.tableName,filter:{id:e},success:BX.proxy((function(r){r.items.length>0?this.cacheDataBase.updateRows({tableName:this.tableParams.tableName,updateFields:{content:a,hash:t,props:s},filter:{id:e},fail:function(e){}}):this.cacheDataBase.addRow({tableName:this.tableParams.tableName,insertFields:{id:e,content:a,hash:t,props:s}})}),this),fail:BX.proxy((function(r){this.cacheDataBase.addRow({tableName:this.tableParams.tableName,insertFields:{id:e,content:a,hash:t,props:s},fail:function(e){}})}),this)}))},BX.frameCache.readCacheWithID=function(e,a){BX.frameCache.openDatabase()?this.cacheDataBase.getRows({tableName:this.tableParams.tableName,filter:{id:e},success:BX.proxy(a,this)}):void 0!==a&&a({items:[]})},BX.frameCache.insertBanner=function(){this.vars.banner&&BX.type.isNotEmptyString(this.vars.banner.text)&&BX.ready(BX.proxy((function(){var e=BX.create("a",{props:{className:"bx-composite-btn"+(BX.type.isNotEmptyString(this.vars.banner.style)?" bx-btn-"+this.vars.banner.style:""),href:this.vars.banner.url},attrs:{target:"_blank"},text:this.vars.banner.text});BX.type.isNotEmptyString(this.vars.banner.bgcolor)&&(e.style.backgroundColor=this.vars.banner.bgcolor,BX.util.in_array(this.vars.banner.bgcolor.toUpperCase(),["#FFF","#FFFFFF","WHITE"])&&BX.addClass(e,"bx-btn-border"));var a=BX("bx-composite-banner");a?a.appendChild(e):(BX.addClass(e,"bx-composite-btn-fixed"),document.body.appendChild(BX.create("div",{style:{position:"relative"},children:[e]})))}),this))},BX.frameCache.tryUpdateSessid=function(){if(!sessidWasUpdated){var e="bitrix_sessid",a=!1;if(void 0!==BX.message[e])a=BX.message[e];else{var t=BX.frameCache.localStorage.get(localStorageKey)||{};void 0!==t[e]&&(a=t[e])}!1!==a&&(sessidWasUpdated=!0,this.updateSessid(a))}},BX.frameCache.updateSessid=function(e){for(var a=document.getElementsByName("sessid"),t=0;t<a.length;t++)a[t].value=e},BX.frameCache.init()}})(window);