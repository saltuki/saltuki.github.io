!function(e){if(!e.BX.dataBase){var t=e.BX;t.dataBase=function(t){this.tableList=[],this.jsonFields={},void 0!==e.SQLitePlugin&&"function"==typeof e.SQLitePlugin.openDatabase?(this.dbObject=e.SQLitePlugin.openDatabase(t),this.dbBandle="SQLitePlugin"):void 0!==e.openDatabase?(this.dbBandle="openDatabase",this.dbObject=e.openDatabase(t.name,t.version,t.displayName,t.capacity)):(this.dbBandle="undefined",this.dbObject=null)},t.dataBase.create=function(s){return void 0!==e.openDatabase||void 0!==e.SQLitePlugin&&"function"==typeof e.SQLitePlugin.openDatabase?new t.dataBase(s):null},t.dataBase.prototype.setJsonFields=function(e,s){if("string"==typeof s&&(s=""==s?[]:[s]),e&&t.type.isArray(s))if(e=e.toString().toUpperCase(),this.jsonFields[e]=[],s.length>0)for(var n=0;n<s.length;n++)this.jsonFields[e].push(s[n].toString().toUpperCase());else delete this.jsonFields[e];return!0},t.dataBase.prototype.isTableExists=function(e,s){e=e.toUpperCase();var n=new t.Promise;"function"!=typeof s&&(s=function(){});var a=function(t){t.indexOf(e)>-1?(s(!0,e),n.fulfill(e)):(s(!1,e),n.reject(e))};return this.tableList.length<=0?this.getTableList().then(a):a(this.tableList),n},t.dataBase.prototype.getTableList=function(e){var s=new t.Promise;"function"!=typeof e&&(e=function(){});var n=e;return this.query({query:"SELECT tbl_name from sqlite_master WHERE type = 'table'",values:[]}).then(function(e){if(this.tableList=[],e.result.count>0)for(var t=0;t<e.result.items.length;t++)this.tableList[this.tableList.length]=e.result.items[t].tbl_name.toString().toUpperCase();n(this.tableList),s.fulfill(this.tableList)}.bind(this)).catch((function(e){s.reject(e)})),s},t.dataBase.prototype.createTable=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="create",this.query(this.getQuery(e)).then(function(t){this.getTableList(),t.result.tableName=e.tableName,e.success(t.result,t.transaction),s.fulfill(t)}.bind(this)).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.dropTable=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="drop",this.query(this.getQuery(e)).then(function(t){this.getTableList(),t.result.tableName=e.tableName,e.success(t.result,t.transaction),s.fulfill(t)}.bind(this)).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.addRow=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="insert",this.query(this.getQuery(e)).then((function(t){e.success(t.result,t.transaction),t.result.tableName=e.tableName,s.fulfill(t)})).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.replaceRow=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="replace",this.query(this.getQuery(e)).then((function(t){e.success(t.result,t.transaction),t.result.tableName=e.tableName,s.fulfill(t)})).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.getRows=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="select",this.query(this.getQuery(e)).then(function(t){var n=e.tableName.toString().toUpperCase();if(this.jsonFields[n]&&this.jsonFields[n].length&&t.result.items.length)for(var a=0;a<t.result.items.length;a++)for(var i=0;i<this.jsonFields[n].length;i++)t.result.items[a][this.jsonFields[n][i]]&&(t.result.items[a][this.jsonFields[n][i]]=JSON.parse(t.result.items[a][this.jsonFields[n][i]]));e.success(t.result,t.transaction),t.result.tableName=e.tableName,s.fulfill(t)}.bind(this)).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.updateRows=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="update",this.query(this.getQuery(e)).then((function(t){e.success(t.result,t.transaction),t.result.tableName=e.tableName,s.fulfill(t)})).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.deleteRows=function(e){var s=new t.Promise;return"function"!=typeof(e=e||{}).success&&(e.success=function(e,t){}),"function"!=typeof e.fail&&(e.fail=function(e,t,s){}),e.action="delete",this.query(this.getQuery(e)).then((function(t){e.success(t.result,t.transaction),t.result.tableName=e.tableName,s.fulfill(t)})).catch((function(t){e.fail(t.result,t.transaction,t.query,e),t.queryParams=e,s.reject(t)})),s},t.dataBase.prototype.getQuery=function(e){var s=[],n=e.filter,a=e.order||null,i=e.limit||null,r=e.fields,o=e.insertFields,u=e.updateFields,l=e.tableName,c="";switch(e.action){case"create":var f="";if("object"==typeof r)for(var p="",h=0;h<r.length;h++)p="","","object"==typeof r[h]?(r[h].name&&(p=r[h].name),p&&r[h].type&&("integer"!=r[h].type.toLowerCase()&&"real"!=r[h].type.toLowerCase()&&"text"!=r[h].type.toLowerCase()||(p+=" "+r[h].type)),p&&r[h].unique&&1==r[h].unique&&(p+=" unique")):"string"==typeof r[h]&&r[h].length>0&&(p=r[h]),p.length>0&&(f.length>0?f+=","+p.toUpperCase():f=p.toUpperCase());c="CREATE TABLE IF NOT EXISTS "+l.toUpperCase()+" ("+f+") ";break;case"drop":c="DROP TABLE IF EXISTS "+l.toUpperCase();break;case"select":var y=[];if(a&&"object"==typeof a)for(var g in a)a.hasOwnProperty(g)&&y.push(g+" "+("DESC"==a[g]?"DESC":"ASC"));var b=null;i&&("object"==typeof i?b=parseInt(i.limit)+(i.offset?", "+parseInt(i.offset):""):"number"==typeof i&&(b=i)),c="SELECT "+this.getValueArrayString(r,"*")+" FROM "+l.toUpperCase()+" "+this.getFilter(n)+(y.length>0?" ORDER BY "+y.join(", ")+" ":"")+(b?" LIMIT "+b+" ":""),s=this.getValues([n]);break;case"replace":var d=0,v=0,m="";if(t.type.isArray(o)){for(var j in s=this.getValues(o,"insert"),o[0])v++;d=o.length,m=this.getKeyString(o[0])}else d=1,v=(s=this.getValues([o],"insert")).length,m=this.getKeyString(o);c="REPLACE INTO "+l.toUpperCase()+" ("+m+") VALUES %values%";var S=[],q=[];for(j=0;j<d;j++){S=[];for(h=0;h<v;h++)S.push("?");q.push(S.join(","))}c=c.replace("%values%","("+q.join("), (")+")");break;case"insert":d=0,v=0,m="";if(t.type.isArray(o)){for(var j in s=this.getValues(o,"insert"),o[0])v++;d=o.length,m=this.getKeyString(o[0])}else d=1,v=(s=this.getValues([o],"insert")).length,m=this.getKeyString(o);c="INSERT INTO "+l.toUpperCase()+" ("+m+") VALUES %values%";for(S=[],q=[],j=0;j<d;j++){S=[];for(h=0;h<v;h++)S.push("?");q.push(S.join(","))}c=c.replace("%values%","("+q.join("), (")+")");break;case"delete":c="DELETE FROM "+l.toUpperCase()+" "+this.getFilter(n),s=this.getValues([n]);break;case"update":c="UPDATE "+l.toUpperCase()+" "+this.getFieldPair(u,"SET ")+" "+this.getFilter(n),s=this.getValues([u],"update").concat(this.getValues([n]))}return{query:c,values:s}},t.dataBase.prototype.getFieldPair=function(e,t){var s="",n=t||"";if("object"==typeof e){var a=0;for(var i in e){var r=(a>0?", ":"")+i.toUpperCase()+"=?";0==s.length&&n.length>0&&(s=n),s+=r,a++}}return s},t.dataBase.prototype.getFilter=function(e){var t="";if("object"==typeof e){for(var s in e){var n="",a=1;"object"==typeof e[s]&&(a=e[s].length);for(var i=0;i<a;i++)n=(i>0?n+" OR ":"(")+s.toUpperCase()+"=?",i+1==a&&(n+=")");t+=n}}else"string"==typeof e&&(t=e);return""==t?"":"WHERE "+t},t.dataBase.prototype.getKeyString=function(e,s){var n="";if(s||(s=""),t.type.isArray(e))for(var a=0;a<e.length;a++)for(var i in e[a])n.length>0?n+=","+i.toUpperCase():n=i.toUpperCase();else if("object"==typeof e)for(var i in e)n.length>0?n+=","+i.toUpperCase():n=i.toUpperCase();return 0==n.length&&(n=s),n},t.dataBase.prototype.getValueArrayString=function(e,t){var s="";if(t||(t=""),"object"==typeof e)for(var n=0;n<e.length;n++)s.length>0?s+=","+e[n].toUpperCase():s=e[n].toUpperCase();return 0==s.length&&(s=t),s},t.dataBase.prototype.getValues=function(e,s){s=s||"undefined";for(var n=[],a=0;a<e.length;a++){var i=e[a];if(t.type.isArray(i))for(var r=0;r<i.length;r++)if("insert"!=s&&"update"!=s||"object"!=typeof i[r])if("object"==typeof i[r])for(var o in i[r])"object"==typeof i[r][o]?n.push(JSON.stringify(i[r][o])):n.push(i[r][o]);else n.push(i[r]);else n.push(JSON.stringify(i[r]));else if("object"==typeof i)for(var r in i)if("insert"!=s&&"update"!=s||"object"!=typeof i[r])if("object"==typeof i[r])for(var o in i[r])"object"==typeof i[r][o]?n.push(JSON.stringify(i[r][o])):n.push(i[r][o]);else n.push(i[r]);else n.push(JSON.stringify(i[r]))}return n},t.dataBase.prototype.query=function(e,s,n){var a=new t.Promise;return"function"!=typeof s&&(s=function(e,t){}),"function"!=typeof n&&(n=function(e,t,s){}),this.dbObject?(this.dbObject.transaction((function(t){t.executeSql(e.query,e.values,(function(e,t){var n={originalResult:t},i=t.rows.length;if(i>=0){n.count=i,n.items=[];for(var r=0;r<i;r++){var o={},u=t.rows.item(r);for(var l in u)u.hasOwnProperty(l)&&(o[l]=u[l]);n.items.push(o)}}s(n,e),a.fulfill({result:n,transaction:e})}),(function(t,s){n(s,t,e),a.reject({result:s,transaction:t,query:e})}))}),(function(e){console.error("BX.dataBase.prototype.query: ",e),a.reject(null,null,null)})),a):(n(null,null,null),a.reject(null,null,null),a)},t.dataBase.prototype.getResponseObject=function(e){for(var t=e.rows.length,s=[],n=0;n<t;n++)s[s.length]=e.rows.item(n);return s}}}(window);